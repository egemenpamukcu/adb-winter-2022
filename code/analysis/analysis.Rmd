---
title: "Fragility Analysis"
author: "Egemen Pamukcu"
date: "3/1/2022"
output: html_document
---

## Loading Libraries
```{r}
library(tidyverse)
# install.packages("vtable")
library(vtable)
# install.packages("Hmisc")
library("Hmisc")
# install.packages("corrplot")
library(corrplot)
library(naniar)
library(corrplot)
library(stargazer)
```

## Loading Data
```{r}
df <- read_csv("../data/cleaned-datasets/final/small_data_imputed.csv")

cols <-  c('iso', 'country_name', 'year')

migration <- c('ims_both_sex', 'estimated_refugee_stock_incl_asylum_seekers_both_sexes', 'disaster_stock_displacementr_raw', 'conflict_stock_displacement_raw')

climate <- c('CCH', 'AIR', 'hdi_value')

governance <- c('value.Rule of Law: Estimate', 'value.Government Effectiveness: Estimate', 'value.Control of Corruption: Estimate')

ys <- c('P1: State Legitimacy', 'D_avg', 'D12')

controls <- c('GDP per capita (constant 2015 US$)', 'value.Gini index (World Bank estimate)')

df <- df %>% 
  rename(migrant_stock=ims_both_sex, 
         refugee_stock=estimated_refugee_stock_incl_asylum_seekers_both_sexes,
         disaster_displacement=disaster_stock_displacementr_raw,
         conflict_displacement=conflict_stock_displacement_raw, 
         climate_change=CCH, 
         air_quality=AIR, 
         rule_of_law=`value.Rule of Law: Estimate`, 
         gov_effectiveness=`value.Government Effectiveness: Estimate`, 
         corruption_control=`value.Control of Corruption: Estimate`,
         state_legit=`P1: State Legitimacy`, 
         cpa_d_12=D12, 
         cpa_d_avg=D_avg, 
         gdp=`GDP per capita (constant 2015 US$)`, 
         gini=`value.Gini index (World Bank estimate)`) %>% 
  mutate(conflict_displacement=conflict_displacement/10000, 
         disaster_displacement=disaster_displacement/10000,
         migrant_stock=migrant_stock/10000,
         refugee_stock=refugee_stock/10000,
         gdp=gdp/1000)

names(df)
```

## Descriptive Statistics
```{r}
vis_miss(df, sort_miss = T)
```

```{r}
head(sumtable(df, out='return'), 10)
```


```{r}
df.cpa <- df %>% 
  drop_na('cpa_d_avg')

df.rcorr <- df %>% 
  select(-iso, -country_name) %>% 
  as.matrix() %>% 
  rcorr()

corrplot(corr=df.rcorr$r,
         p.mat = df.rcorr$P,
         type='lower', insig='pch', sig.level =.1, pch.cex = .9, diag=F,
         tl.cex=.7, tl.col='black', tl.offset=1, cl.pos='r')
```

```{r}
dist_plots <- lapply(names(df %>% 
                             select(-iso, -country_name)), function(var_x){
  p <- 
    ggplot(df) +
    aes_string(var_x) +
    theme(
      axis.text = element_blank(),
      axis.title.y = element_blank(),
      axis.title.x = element_text(family='Helvetica', size=9),
      axis.ticks = element_blank()
      )
    
  if(is.numeric(df[[var_x]])) {
    p <- p + geom_density()
  }
})


cowplot::plot_grid(plotlist = dist_plots)

# split into pillars
```


```{r}
scatter_plots <- lapply(names(df %>% 
                             select(-iso, -country_name, -state_legit)), 
                        function(var_x){
  ggplot(df, aes_string(x=var_x, y='state_legit')) + 
  geom_point() +
  geom_smooth(method='lm', formula='y~x') + 
  ggrepel::geom_text_repel(label=df$iso)
})

scatter_plots
# wo afg
```



```{r}
climate.model <- lm(state_legit ~ climate_change + air_quality + hdi_value, df)
governance.model <- lm(state_legit ~ rule_of_law + gov_effectiveness + corruption_control, df)
migration.model <- lm(state_legit ~ migrant_stock + refugee_stock + conflict_displacement + disaster_displacement, df)
full.model <- lm(state_legit ~ rule_of_law + gov_effectiveness + corruption_control + migrant_stock + refugee_stock + conflict_displacement + disaster_displacement + climate_change + air_quality + hdi_value, df)

stargazer(climate.model, migration.model, governance.model, full.model, type='text')
```

```{r}
climate.model <- lm(cpa_d_avg ~ climate_change + air_quality + hdi_value, df)
governance.model <- lm(cpa_d_avg ~ rule_of_law + gov_effectiveness + corruption_control, df)
migration.model <- lm(cpa_d_avg ~ migrant_stock + refugee_stock + conflict_displacement + disaster_displacement, df)
full.model <- lm(cpa_d_avg ~ rule_of_law + gov_effectiveness + corruption_control + migrant_stock + refugee_stock + conflict_displacement + disaster_displacement + climate_change + air_quality + hdi_value, df)

stargazer(climate.model, migration.model, governance.model, full.model, type='text')
```

```{r}
climate.model <- lm(cpa_d_12 ~ climate_change + air_quality + hdi_value, df)
governance.model <- lm(cpa_d_12 ~ rule_of_law + gov_effectiveness + corruption_control, df)
migration.model <- lm(cpa_d_12 ~ migrant_stock + refugee_stock + conflict_displacement + disaster_displacement, df)
full.model <- lm(cpa_d_12 ~ rule_of_law + gov_effectiveness + corruption_control + migrant_stock + refugee_stock + conflict_displacement + disaster_displacement + climate_change + air_quality + hdi_value, df)

stargazer(climate.model, migration.model, governance.model, full.model, type='text')
```

